name: "Project Auto-Manager"

on:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened]

permissions:
  issues: write
  pull-requests: write
  repository: read

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      # 1. Onboarding: ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢ Contributor ‡∏´‡∏ô‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
      - name: "Welcome Newcomer"
        if: github.event.action == 'opened' && github.actor != github.repository_owner
        uses: actions/github-script@v7
        with:
          script: |
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GitHub API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏°‡∏µ PR ‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏°
            const creator = context.payload.sender.login;
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: creator
            });
            
            if (prs.length <= 1) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `üëã ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì @${creator} ‡∏™‡∏π‡πà‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏Ñ‡∏£‡∏±‡∏ö`
              });
            }

      # 2. Auto-Labeling: ‡∏ï‡∏¥‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏ï‡∏≤‡∏° Keywords
      - name: "Auto Labeler"
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue ? context.payload.issue.body : context.payload.pull_request.body;
            const title = context.payload.issue ? context.payload.issue.title : context.payload.pull_request.title;
            const text = (title + " " + body).toLowerCase();
            
            const labels = [];
            if (text.includes('bug') || text.includes('error')) labels.push('bug');
            if (text.includes('feature') || text.includes('add')) labels.push('enhancement');
            if (text.includes('urgent')) labels.push('high-priority');
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: labels
              });
            }

      # 3. Project Planning: ‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏Ç‡πâ‡∏≤‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÉ‡∏ä‡πâ gh cli)
      - name: "Add to Project Board"
        env:
          GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN }} # ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Token ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Project
          PROJECT_NUMBER: 1 # ‡πÄ‡∏•‡∏Ç Project ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
          USER: my-username
        run: |
          gh project item-create $PROJECT_NUMBER --owner $USER --url ${{ github.event.issue.html_url || github.event.pull_request.html_url }}

